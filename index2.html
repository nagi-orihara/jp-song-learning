<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聽歌學日文 - 聯網修正版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-hidden { display: none; }
        .active-tab { border-bottom: 4px solid #6366f1; color: #6366f1; font-weight: bold; }
        .content-display { white-space: pre-wrap; word-wrap: break-word; line-height: 1.8; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen pb-12 text-slate-900">
    <div class="max-w-xl mx-auto bg-white min-h-screen shadow-2xl overflow-hidden flex flex-col">
        
        <header class="bg-indigo-600 p-4 text-white flex justify-between items-center shadow-lg">
            <h1 class="font-bold text-lg tracking-tighter">聽歌學日文</h1>
            <input type="date" id="datePicker" class="text-black p-1 rounded text-sm outline-none" onchange="loadLesson()">
        </header>

        <div id="videoBox" class="bg-black aspect-video w-full flex items-center justify-center shadow-inner overflow-hidden">
            <p class="text-gray-500 text-xs text-center">輸入歌名後點擊「AI 生成」<br>(啟用 Google 搜尋模式)</p>
        </div>

        <div class="p-4 bg-indigo-50 border-b border-indigo-100">
            <div class="mb-4">
                <input type="password" id="apiKey" class="w-full p-2 border rounded text-xs mb-2" placeholder="貼上你的 API Key">
                <div class="flex gap-2">
                    <input type="text" id="songName" class="flex-1 p-2 border rounded text-sm shadow-inner" placeholder="歌名歌手 (如: 狂乱 Hey Kids!! THE ORAL CIGARETTES)">
                    <button onclick="askAI()" id="aiBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-indigo-700 active:scale-95 transition">AI 生成</button>
                </div>
            </div>

            <details class="text-gray-500 text-xs">
                <summary class="cursor-pointer">手動編輯 / 檢查代碼</summary>
                <div class="mt-2 space-y-2">
                    <input type="text" id="in-yt" class="w-full p-2 border rounded" placeholder="YouTube ID (如: rgS27LlO_5U)">
                    <textarea id="in-l" class="w-full h-24 p-2 border rounded" placeholder="歌詞對照..."></textarea>
                    <textarea id="in-w" class="w-full h-24 p-2 border rounded" placeholder="單字表..."></textarea>
                    <textarea id="in-g" class="w-full h-24 p-2 border rounded" placeholder="文法解析..."></textarea>
                    <button onclick="saveData()" class="w-full bg-slate-700 text-white py-2 rounded font-bold mt-2">手動儲存</button>
                </div>
            </details>
        </div>

        <div class="flex border-b bg-white sticky top-0 z-10">
            <button onclick="showTab(1)" id="t1" class="flex-1 py-4 text-sm active-tab">歌詞對照</button>
            <button onclick="showTab(2)" id="t2" class="flex-1 py-4 text-sm text-gray-400">重點單字</button>
            <button onclick="showTab(3)" id="t3" class="flex-1 py-4 text-sm text-gray-400">文法例句</button>
        </div>

        <div class="p-6 flex-1 bg-white">
            <div id="c1" class="content-display text-gray-700 text-sm"></div>
            <div id="c2" class="content-display text-gray-700 text-sm card-hidden"></div>
            <div id="c3" class="content-display text-gray-700 text-sm card-hidden"></div>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        window.askAI = async function() {
            const key = document.getElementById('apiKey').value.trim();
            const song = document.getElementById('songName').value.trim();
            const btn = document.getElementById('aiBtn');
            if(!key || !song) return alert("請輸入 API Key 與歌名");

            btn.disabled = true;
            btn.innerText = "搜尋並生成中...";
            localStorage.setItem('my-gemini-key', key);

            // 定義我們要嘗試的模型清單 (優先用 2.0，失敗則用 3.0)
            const modelsToTry = ["gemini-2.0-flash", "gemini-3-flash-preview"];
            let success = false;

            for (const modelName of modelsToTry) {
                if (success) break;
                console.log("嘗試模型:", modelName);

                try {
                    const genAI = new GoogleGenerativeAI(key);
                    // 設定模型與搜尋工具
                    const model = genAI.getGenerativeModel({ 
                        model: modelName,
                        tools: [{ googleSearchRetrieval: {} }] 
                    });

                    const prompt = `請先使用 Google 搜尋獲取歌曲《${song}》的正確官方資料 (YouTube ID 與歌詞)。
                    然後按照以下格式生成，各部分之間用 [SPLIT] 隔開：
                    1. 正確的 YouTube 11位字元 ID (只要代碼，不要網址)
                    [SPLIT]
                    2. 全曲完整的日文歌詞與中文翻譯對照
                    [SPLIT]
                    3. 8個重點單字 (【單字】(假名) - 中文)
                    [SPLIT]
                    4. 3個重要文法點解析與例句。
                    
                    請確保歌詞順序正確且內容完整，不要使用 Markdown 符號。`;

                    const result = await model.generateContent(prompt);
                    const text = (await result.response).text();
                    const parts = text.split('[SPLIT]');

                    if(parts.length >= 4) {
                        document.getElementById('in-yt').value = parts[0].trim().replace(/\s/g, ''); // 去除多餘空白
                        document.getElementById('in-l').value = parts[1].trim();
                        document.getElementById('in-w').value = parts[2].trim();
                        document.getElementById('in-g').value = parts[3].trim();
                        saveData();
                        alert(`成功！使用模型: ${modelName}\n內容已透過 Google 搜尋校對。`);
                        success = true;
                    }
                } catch (err) {
                    console.log(`模型 ${modelName} 失敗:`, err.message);
                    // 如果是最後一個模型也失敗，才顯示錯誤給使用者
                    if (modelName === modelsToTry[modelsToTry.length - 1]) {
                         alert(`生成失敗 (所有模型嘗試無效)\n錯誤訊息: ${err.message}\n\n可能原因：API 配額不足或伺服器忙碌，請明天再試。`);
                    }
                }
            }
            
            btn.disabled = false;
            btn.innerText = "AI 生成";
        };

        window.showTab = function(n) {
            for(let i=1; i<=3; i++) {
                document.getElementById('t'+i).className = "flex-1 py-4 text-sm text-gray-400";
                document.getElementById('c'+i).classList.add('card-hidden');
            }
            document.getElementById('t'+n).className = "flex-1 py-4 text-sm active-tab";
            document.getElementById('c'+n).classList.remove('card-hidden');
        };

        window.saveData = function() {
            const date = document.getElementById('datePicker').value;
            const data = {
                yt: document.getElementById('in-yt').value.trim(),
                l: document.getElementById('in-l').value,
                w: document.getElementById('in-w').value,
                g: document.getElementById('in-g').value
            };
            localStorage.setItem('lesson-' + date, JSON.stringify(data));
            loadLesson();
        };

        window.loadLesson = function() {
            const date = document.getElementById('datePicker').value;
            const raw = localStorage.getItem('lesson-' + date);
            const savedKey = localStorage.getItem('my-gemini-key');
            if(savedKey) document.getElementById('apiKey').value = savedKey;

            if(raw) {
                const item = JSON.parse(raw);
                document.getElementById('in-yt').value = item.yt || "";
                document.getElementById('in-l').value = item.l || "";
                document.getElementById('in-w').value = item.w || "";
                document.getElementById('in-g').value = item.g || "";

                if(item.yt && item.yt.length >= 10) {
                    document.getElementById('videoBox').innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${item.yt}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
                } else {
                    document.getElementById('videoBox').innerHTML = `<p class="text-gray-500">影片 ID 無效</p>`;
                }
                document.getElementById('c1').innerText = item.l;
                document.getElementById('c2').innerText = item.w;
                document.getElementById('c3').innerText = item.g;
            } else {
                document.getElementById('videoBox').innerHTML = `<p class="text-gray-500">今日尚無內容</p>`;
                document.getElementById('c1').innerText = "點擊 AI 生成開始";
            }
        };

        window.onload = function() {
            document.getElementById('datePicker').value = new Date().toISOString().split('T')[0];
            loadLesson();
        };
    </script>
</body>
</html>